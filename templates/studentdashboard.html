<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Student Dashboard - Pi-Elearn</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    :root{--primary:#17a2b8;--secondary:#f8f9fa;--text:#333;--border:#dee2e6;--success:#28a745;--warning:#ffc107;--shadow:0 2px 10px rgba(0,0,0,.1)}
    body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;color:var(--text);background:#f8f9fa;line-height:1.6}
    .header{background:#fff;box-shadow:var(--shadow);padding:1rem 0;position:sticky;top:0;z-index:100}
    .nav-container{max-width:1200px;margin:0 auto;padding:0 1rem;display:flex;justify-content:space-between;align-items:center}
    .logo{font-size:1.5rem;font-weight:700;color:var(--primary);text-decoration:none}
    .nav-links{display:flex;gap:1rem;align-items:center}
    .nav-link{color:var(--text);text-decoration:none;font-weight:500}
    .nav-link:hover{color:var(--primary)}
    .user-info{display:flex;align-items:center;gap:1rem}
    .logout-btn{background:none;border:1px solid var(--border);padding:.5rem 1rem;border-radius:6px;cursor:pointer}
    .logout-btn:hover{background:var(--secondary)}
    .container{max-width:1200px;margin:0 auto;padding:2rem 1rem}
    .section{background:#fff;border-radius:12px;padding:2rem;margin-bottom:2rem;box-shadow:var(--shadow)}
    .section-title{font-size:1.5rem;font-weight:600;color:var(--text);margin-bottom:1rem}
    .courses-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:1.5rem}
    .course-card{border:1px solid var(--border);border-radius:12px;overflow:hidden;background:#fff;transition:all .2s}
    .course-card:hover{transform:translateY(-6px);box-shadow:0 8px 25px rgba(0,0,0,.08)}
    .course-thumbnail{width:100%;height:160px;object-fit:cover}
    .course-content{padding:1.25rem}
    .course-title{font-size:1.05rem;font-weight:600;margin-bottom:.4rem}
    .course-instructor{color:#666;font-size:.9rem;margin-bottom:1rem}
    .course-rating{display:flex;align-items:center;gap:0.5rem;margin-bottom:0.5rem;font-size:0.9rem}
    .stars{color:var(--warning)}
    .progress-text{display:flex;justify-content:space-between;font-size:.8rem;color:#666;margin-bottom:.5rem}
    .progress-bar{width:100%;height:6px;background:var(--border);border-radius:3px;overflow:hidden}
    .progress-fill{height:100%;background:var(--success);transition:width .3s ease}
    .continue-btn{width:100%;padding:.75rem;background:var(--primary);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-top:0.5rem}
    .continue-btn:hover{background:#138496}
    .certificate-btn{width:100%;padding:.75rem;background:var(--success);color:#fff;border:none;border-radius:6px;cursor:pointer;font-weight:600;margin-top:0.5rem}
    .certificate-btn:hover{background:#218838}
    .certificate-btn:disabled{background:#6c757d;cursor:not-allowed}
    .certificates-list{display:flex;flex-direction:column;gap:1rem}
    .certificate-item{display:flex;justify-content:space-between;align-items:center;padding:1rem;border:1px solid var(--border);border-radius:8px;background:#fff}
    .download-btn{padding:.5rem 1rem;background:var(--success);color:#fff;border:none;border-radius:6px;text-decoration:none;cursor:pointer}
    .empty-state{padding:2rem;text-align:center;color:#666}
    .loading{display:flex;align-items:center;justify-content:center;padding:3rem;color:#666}
    .spinner{border:3px solid #f3f3f3;border-top:3px solid var(--primary);border-radius:50%;width:30px;height:30px;animation:spin 1s linear infinite;margin-right:1rem}
    .toast-container{position:fixed;top:20px;right:20px;z-index:1001}
    .toast{background:white;border-radius:8px;padding:1rem;margin-bottom:0.5rem;box-shadow:0 4px 12px rgba(0,0,0,0.15);border-left:4px solid var(--primary);display:flex;align-items:center;gap:0.75rem;min-width:300px}
    .toast.success{border-left-color:var(--success)}
    .toast.error{border-left-color:#dc3545}
    
    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1002;
      padding: 1rem;
    }
    
    .modal {
      background: white;
      border-radius: 12px;
      padding: 2rem;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    
    .modal-title {
      font-size: 1.5rem;
      font-weight: 600;
      margin-bottom: 1rem;
      text-align: center;
    }
    
    .modal-course-title {
      font-size: 1.1rem;
      color: var(--primary);
      text-align: center;
      margin-bottom: 1.5rem;
    }
    
    .rating-stars-modal {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .star-modal {
      font-size: 2.5rem;
      cursor: pointer;
      color: #ddd;
      transition: color 0.2s;
    }
    
    .star-modal:hover,
    .star-modal.active {
      color: var(--warning);
    }
    
    .review-input-modal {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 1rem;
      margin-bottom: 1rem;
      resize: vertical;
      min-height: 80px;
    }
    
    .char-count {
      text-align: right;
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 1.5rem;
    }
    
    .char-count.warning {
      color: #dc3545;
    }
    
    .modal-buttons {
      display: flex;
      gap: 1rem;
      justify-content: flex-end;
    }
    
    .modal-btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modal-btn-cancel {
      background: #6c757d;
      color: white;
    }
    
    .modal-btn-cancel:hover {
      background: #5a6268;
    }
    
    .modal-btn-submit {
      background: var(--primary);
      color: white;
    }
    
    .modal-btn-submit:hover {
      background: #138496;
    }
    
    .modal-btn-submit:disabled {
      background: #6c757d;
      cursor: not-allowed;
    }
    
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    @media(max-width:768px){.nav-links{gap:.5rem}.courses-grid{grid-template-columns:1fr}.certificate-item{flex-direction:column;gap:1rem;text-align:center}}
  </style>
  <script src="https://sdk.minepi.com/pi-sdk.js"></script>
  <script>Pi.init({ version: "2.0", sandbox: true });</script>
</head>
<body>

<header class="header">
  <div class="nav-container">
    <a href="/" class="logo">Pi-Elearn</a>
    <div class="nav-links">
      <a href="/" class="nav-link">Home</a>
      <a href="/details.html" class="nav-link">Browse</a>
      <div class="user-info">
        <span id="userName">Student</span>
        <button class="logout-btn" id="logoutBtn">Logout</button>
      </div>
    </div>
  </div>
</header>

<main class="container">
  <div class="section">
    <h2 class="section-title" id="welcomeTitle">Welcome back!</h2>
    <p id="welcomeText" style="color:#666;margin-top:.5rem">Continue your learning journey.</p>
  </div>

  <div class="section">
    <h3 class="section-title">My Courses</h3>
    <div id="coursesLoading" class="loading"><div class="spinner"></div>Loading your courses...</div>
    <div id="coursesEmpty" class="empty-state" style="display:none">
      <div style="font-size:3rem;margin-bottom:.5rem">üìö</div>
      <h4>No courses yet</h4>
      <p>Enroll in a course to start learning.</p>
      <a href="/" class="continue-btn" style="display:inline-block;width:auto;margin-top:1rem">Browse Courses</a>
    </div>
    <div id="coursesGrid" class="courses-grid" style="display:none"></div>
  </div>

  <div class="section">
    <h3 class="section-title">My Certificates</h3>
    <div id="certificatesLoading" class="loading"><div class="spinner"></div>Loading certificates...</div>
    <div id="certificatesEmpty" class="empty-state" style="display:none">
      <div style="font-size:3rem;margin-bottom:.5rem">üèÜ</div>
      <h4>No certificates yet</h4>
      <p>Complete a course to earn a certificate.</p>
    </div>
    <div id="certificatesList" class="certificates-list" style="display:none"></div>
  </div>
</main>

<!-- Rating Modal -->
<div id="ratingModal" class="modal-overlay" style="display: none;">
  <div class="modal">
    <h2 class="modal-title">Rate this Course</h2>
    <div class="modal-course-title" id="modalCourseTitle">Course Title</div>
    
    <div class="rating-stars-modal" id="modalStars">
      <span class="star-modal" data-rating="1">‚òÜ</span>
      <span class="star-modal" data-rating="2">‚òÜ</span>
      <span class="star-modal" data-rating="3">‚òÜ</span>
      <span class="star-modal" data-rating="4">‚òÜ</span>
      <span class="star-modal" data-rating="5">‚òÜ</span>
    </div>
    
    <textarea 
      class="review-input-modal" 
      id="modalReviewInput" 
      placeholder="Share your experience with this course (optional, max 100 characters)"
      maxlength="100"
    ></textarea>
    
    <div class="char-count" id="charCount">0/100 characters</div>
    
    <div class="modal-buttons">
      <button class="modal-btn modal-btn-cancel" id="modalCancelBtn">Cancel</button>
      <button class="modal-btn modal-btn-submit" id="modalSubmitBtn" disabled>Submit Rating</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
const endpoints = {
  me: '/api/auth/me',
  courses: '/api/courses/enrolled',
  certificates: '/api/certificates/my',
  generateCertificate: '/api/certificates/generate',
  ratings: '/api/ratings'
};

const DOM = {
  userName: document.getElementById('userName'),
  welcomeTitle: document.getElementById('welcomeTitle'),
  logoutBtn: document.getElementById('logoutBtn'),
  coursesLoading: document.getElementById('coursesLoading'),
  coursesEmpty: document.getElementById('coursesEmpty'),
  coursesGrid: document.getElementById('coursesGrid'),
  certificatesLoading: document.getElementById('certificatesLoading'),
  certificatesEmpty: document.getElementById('certificatesEmpty'),
  certificatesList: document.getElementById('certificatesList'),
  toastContainer: document.getElementById('toastContainer'),
  // Modal elements
  ratingModal: document.getElementById('ratingModal'),
  modalCourseTitle: document.getElementById('modalCourseTitle'),
  modalStars: document.getElementById('modalStars'),
  modalReviewInput: document.getElementById('modalReviewInput'),
  charCount: document.getElementById('charCount'),
  modalCancelBtn: document.getElementById('modalCancelBtn'),
  modalSubmitBtn: document.getElementById('modalSubmitBtn')
};

let currentAccessToken = null;
let userRatings = new Map(); // course_id -> rating data
let currentRatingCourse = null;
let selectedRating = 0;

document.addEventListener('DOMContentLoaded', init);

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.innerHTML = `
    <span>${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : '‚ÑπÔ∏è'}</span>
    <span>${message}</span>
  `;
  DOM.toastContainer.appendChild(toast);
  
  setTimeout(() => {
    toast.remove();
  }, 5000);
}

// Modal functions
function openRatingModal(courseId, courseTitle) {
  currentRatingCourse = courseId;
  selectedRating = 0;
  
  DOM.modalCourseTitle.textContent = courseTitle;
  DOM.modalReviewInput.value = '';
  DOM.charCount.textContent = '0/100 characters';
  DOM.charCount.classList.remove('warning');
  DOM.modalSubmitBtn.disabled = true;
  
  // Reset stars
  const stars = DOM.modalStars.querySelectorAll('.star-modal');
  stars.forEach(star => {
    star.textContent = '‚òÜ';
    star.classList.remove('active');
  });
  
  DOM.ratingModal.style.display = 'flex';
}

function closeRatingModal() {
  DOM.ratingModal.style.display = 'none';
  currentRatingCourse = null;
  selectedRating = 0;
}

function setupModalStars() {
  const stars = DOM.modalStars.querySelectorAll('.star-modal');
  stars.forEach(star => {
    star.addEventListener('click', () => {
      const rating = parseInt(star.getAttribute('data-rating'));
      selectedRating = rating;
      
      // Update stars display
      stars.forEach((s, index) => {
        if (index < rating) {
          s.textContent = '‚òÖ';
          s.classList.add('active');
        } else {
          s.textContent = '‚òÜ';
          s.classList.remove('active');
        }
      });
      
      // Enable submit button
      DOM.modalSubmitBtn.disabled = false;
    });
  });
}

function setupModalEvents() {
  // Character count for review
  DOM.modalReviewInput.addEventListener('input', () => {
    const length = DOM.modalReviewInput.value.length;
    DOM.charCount.textContent = `${length}/100 characters`;
    
    if (length > 100) {
      DOM.charCount.classList.add('warning');
    } else {
      DOM.charCount.classList.remove('warning');
    }
  });
  
  // Cancel button
  DOM.modalCancelBtn.addEventListener('click', closeRatingModal);
  
  // Submit button
  DOM.modalSubmitBtn.addEventListener('click', submitRatingFromModal);
  
  // Close modal when clicking outside
  DOM.ratingModal.addEventListener('click', (e) => {
    if (e.target === DOM.ratingModal) {
      closeRatingModal();
    }
  });
}

async function submitRatingFromModal() {
  if (!currentRatingCourse || selectedRating === 0) {
    showToast('Please select a rating', 'error');
    return;
  }

  const review = DOM.modalReviewInput.value.trim();
  
  if (review.length > 100) {
    showToast('Review must be 100 characters or less', 'error');
    return;
  }

  try {
    const res = await fetch(`${endpoints.ratings}/add`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        accessToken: currentAccessToken,
        course_id: currentRatingCourse,
        rating: selectedRating,
        review: review
      })
    });

    const data = await res.json();
    if (data.success) {
      showToast('Rating submitted successfully!', 'success');
      closeRatingModal();
      // Refresh course ratings display
      loadCourses();
    } else {
      showToast(data.error || 'Failed to submit rating', 'error');
    }
  } catch (err) {
    console.error('Error submitting rating:', err);
    showToast('Failed to submit rating', 'error');
  }
}

async function init() {
  try {
    const user = await Pi.authenticate(['username', 'payments'], () => {});
    currentAccessToken = user.accessToken;
    localStorage.setItem('token', currentAccessToken);
    
    const backendUser = await fetchUser(user.accessToken);
    if (!backendUser) throw new Error("Backend auth failed");

    DOM.userName.textContent = backendUser.username;
    DOM.welcomeTitle.textContent = `Welcome back, ${backendUser.username}!`;
    DOM.logoutBtn.addEventListener('click', logout);

    // Setup modal events
    setupModalStars();
    setupModalEvents();

    loadCourses();
    loadCertificates();
  } catch (err) {
    console.error('Init error:', err);
    showToast('Failed to authenticate. Please try again.', 'error');
  }
}

async function fetchUser(accessToken) {
  try {
    const res = await fetch(endpoints.me, {
      credentials: 'include',
      headers: { 'Authorization': `Bearer ${accessToken}` }
    });
    if (!res.ok) return null;
    return await res.json();
  } catch {
    return null;
  }
}

async function fetchProgress(courseId) {
  try {
    const res = await fetch(`/api/progress/${courseId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accessToken: currentAccessToken })
    });
    
    if (!res.ok) return { 
      completed_lectures: 0, 
      total_lectures: 0, 
      progress_percentage: 0,
      completed_lecture_ids: []
    };
    
    const data = await res.json();
    
    if (data.success) {
      return {
        completed_lectures: data.completed_lectures || 0,
        total_lectures: data.total_lectures || 0,
        progress_percentage: data.progress_percentage || 0,
        completed_lecture_ids: data.completed_lecture_ids || []
      };
    } else {
      return { 
        completed_lectures: 0, 
        total_lectures: 0, 
        progress_percentage: 0,
        completed_lecture_ids: []
      };
    }
  } catch (err) {
    console.error('Error fetching progress:', err);
    return { 
      completed_lectures: 0, 
      total_lectures: 0, 
      progress_percentage: 0,
      completed_lecture_ids: []
    };
  }
}

async function fetchLectures(courseId) {
  try {
    const res = await fetch(`/api/courses/lectures/${courseId}`, { credentials: "include" });
    const data = await res.json();
    return data.success ? data.lectures : [];
  } catch {
    return [];
  }
}

async function fetchCourseRatings(courseId) {
  try {
    const res = await fetch(`${endpoints.ratings}/get?course_id=${courseId}`);
    if (!res.ok) return null;
    const data = await res.json();
    return data.success ? data : null;
  } catch (err) {
    console.error('Error fetching ratings:', err);
    return null;
  }
}

async function generateCertificate(courseId) {
  try {
    const res = await fetch(endpoints.generateCertificate, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        accessToken: currentAccessToken,
        course_id: courseId
      })
    });

    const data = await res.json();
    if (data.success) {
      showToast('Certificate generated successfully!', 'success');
      return data.certificate_url;
    } else {
      showToast(data.error || 'Failed to generate certificate', 'error');
      return null;
    }
  } catch (err) {
    console.error('Error generating certificate:', err);
    showToast('Failed to generate certificate', 'error');
    return null;
  }
}

function renderStars(rating, courseId, isInteractive = false) {
  const stars = [];
  for (let i = 1; i <= 5; i++) {
    const isActive = i <= rating;
    stars.push(`
      <span class="star ${isActive ? 'active' : ''} ${isInteractive ? 'interactive' : ''}" 
            ${isInteractive ? `onclick="setRating(${courseId}, ${i})"` : ''}
            data-rating="${i}">
        ${isActive ? '‚òÖ' : '‚òÜ'}
      </span>
    `);
  }
  return stars.join('');
}

async function loadCourses() {
  try {
    const res = await fetch(endpoints.courses, { 
      method: "POST",
      credentials: "include",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ accessToken: currentAccessToken })
    });

    const data = await res.json();
    console.log("API Response:", data);

    const courses = data.courses || [];
    DOM.coursesLoading.style.display = 'none';

    if (!courses.length) {
      DOM.coursesEmpty.style.display = 'block';
      return;
    }

    // Fetch instructor, progress, lecture count, and ratings for each course
    const coursePromises = courses.map(async (course) => {
      try {
        const [instructorRes, progressData, lectures, ratingsData] = await Promise.all([
          fetch(`/api/courses/instructor/${course.instructor_id}`, { credentials: "include" }),
          fetchProgress(course.id),
          fetchLectures(course.id),
          fetchCourseRatings(course.id)
        ]);
        
        const instructor = await instructorRes.json();
        
        return {
          ...course,
          instructor_name: instructor.username || 'Instructor',
          completed_lectures: progressData.completed_lectures || 0,
          total_lectures: progressData.total_lectures || lectures.length || 0,
          progress_percentage: progressData.progress_percentage || 0,
          ratings: ratingsData
        };
      } catch (err) {
        console.error(`Error loading course ${course.id}:`, err);
        return {
          ...course,
          instructor_name: 'Instructor',
          completed_lectures: 0,
          total_lectures: 0,
          progress_percentage: 0,
          ratings: null
        };
      }
    });

    const coursesWithData = await Promise.all(coursePromises);

    // Display the courses
    DOM.coursesGrid.style.display = 'grid';
    DOM.coursesGrid.innerHTML = coursesWithData.map(c => {
      const percent = c.progress_percentage;
      const isCompleted = percent === 100;

      let ratingDisplay = '';
      if (c.ratings && c.ratings.average_rating > 0) {
        ratingDisplay = `
          <div class="course-rating" data-course="${c.id}">
            <span class="stars">${renderStars(c.ratings.average_rating, c.id, false)}</span>
            <span>${c.ratings.average_rating.toFixed(1)} (${c.ratings.ratings.length} reviews)</span>
          </div>
        `;
      }

      return `
        <div class="course-card">
          <img src="${c.thumbnail}" class="course-thumbnail" alt="${c.title}" onerror="this.src='/static/images/default-course.jpg'">
          <div class="course-content">
            <div class="course-title">${c.title}</div>
            <div class="course-instructor">By ${c.instructor_name}</div>
            ${ratingDisplay}
            <div class="progress-text">
              <span>${c.completed_lectures}/${c.total_lectures} lectures</span>
              <span>${percent}%</span>
            </div>
            <div class="progress-bar" style="margin-bottom:12px;">
              <div class="progress-fill" style="width:${percent}%;"></div>
            </div>
            
            <button class="continue-btn" onclick="${isCompleted ? `openRatingModal(${c.id}, '${c.title.replace(/'/g, "\\'")}')` : `window.location.href='/video/${c.id}'`}">
              ${percent === 0 ? 'Start Course' : percent === 100 ? 'Leave a Review' : 'Continue Learning'}
            </button>

            ${isCompleted ? `
              <button class="certificate-btn" onclick="handleCertificateGeneration(${c.id})" id="certificate-btn-${c.id}">
                üèÜ Get Certificate
              </button>
            ` : ''}
          </div>
        </div>`;
    }).join('');

  } catch (err) {
    console.error('Error loading courses:', err);
    DOM.coursesLoading.style.display = 'none';
    DOM.coursesEmpty.style.display = 'block';
    showToast('Failed to load courses', 'error');
  }
}

async function handleCertificateGeneration(courseId) {
  const button = document.getElementById(`certificate-btn-${courseId}`);
  if (button) {
    button.disabled = true;
    button.textContent = 'Generating...';
  }

  const certificateUrl = await generateCertificate(courseId);
  
  if (certificateUrl) {
    // Open certificate in new tab
    window.open(certificateUrl, '_blank');
    // Refresh certificates list
    loadCertificates();
  }

  if (button) {
    button.disabled = false;
    button.textContent = 'üèÜ Get Certificate';
  }
}

async function loadCertificates() {
  try {
    const res = await fetch(endpoints.certificates, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ accessToken: currentAccessToken })
    });

    if (!res.ok) {
      throw new Error('Failed to fetch certificates');
    }

    const data = await res.json();
    DOM.certificatesLoading.style.display = 'none';

    if (!data.success || !data.certificates || data.certificates.length === 0) {
      DOM.certificatesEmpty.style.display = 'block';
      return;
    }

    DOM.certificatesList.style.display = 'flex';
    DOM.certificatesList.innerHTML = data.certificates.map(cert => `
      <div class="certificate-item">
        <div>
          <div style="font-weight:600">${cert.course_title}</div>
          <div style="color:#666;font-size:.9rem">Issued on ${new Date(cert.issued_at).toLocaleDateString()}</div>
        </div>
        <a href="${cert.pdf_url}" class="download-btn" target="_blank">Download</a>
      </div>
    `).join('');

  } catch (err) {
    console.error('Error loading certificates:', err);
    DOM.certificatesLoading.style.display = 'none';
    DOM.certificatesEmpty.style.display = 'block';
    showToast('Failed to load certificates', 'error');
  }
}

async function logout() {
  localStorage.removeItem('token');
  await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
  window.location.href = '/';
}
</script>
</body>
</html>